<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>CRM RCF - Mobile (Firebase Ready)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script crossorigin="anonymous" src="https://kit.fontawesome.com/a2e0e6ad65.js"></script>

<style>
    /* ESTILOS GERAIS */
    body { background: #f8f9fa; font-family: sans-serif; padding-bottom: 80px; }
    
    /* HEADER E NAV */
    header {
      background-color: #2f5d3f;
      color: white;
      padding: 0.75rem 1rem;
      display: flex; justify-content: space-between; align-items: center;
    }
    header h1 { font-weight: bold; font-size: 1.25rem; margin: 0; }
    
    nav { display: flex; overflow-x: auto; background-color: #2f5d3f; scroll-behavior: smooth; }
    nav::-webkit-scrollbar { height: 0px; background: transparent; } /* Oculta scrollbar */
    nav a {
      font-weight: bold; flex: 0 0 auto; padding: 10px; text-align: center;
      color: white; text-decoration: none; font-size: 0.85rem;
      border-right: 1px solid rgba(255,255,255,0.1); min-width: 80px;
    }
    nav a:last-child { border-right: none; }
    nav a:hover, nav a.active { background-color: #3d7a4f; }

    /* UTILS */
    .form-label { font-weight: 600; font-size: 0.9rem; margin-top: 0.5rem;}
    .card { border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .btn-custom-action { font-size: 0.8rem; padding: 4px 8px; }

    /* CALEND√ÅRIO */
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 0.75rem; text-align: center; }
    .calendar-day { 
      background: #e9ecef; border-radius: 4px; min-height: 40px; 
      display: flex; flex-direction: column; align-items: center; justify-content: start; padding-top: 4px;
      cursor: pointer;
    }
    .calendar-day span { font-weight: bold; margin-bottom: 2px; }
    .barra-cor { height: 4px; width: 80%; margin-bottom: 2px; border-radius: 2px; }
    
    .cal-verde { background-color: #198754; } 
    .cal-azul { background-color: #0d6efd; }  
    .cal-roxo { background-color: #6f42c1; }  
    .cal-laranja { background-color: #fd7e14; } 

    .legenda { font-size: 0.7rem; display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
    .legenda-item { display: flex; align-items: center; gap: 5px; }
    .legenda-bolinha { width: 10px; height: 10px; border-radius: 50%; }

    /* ESTILOS DO CONSTRUTOR (Novo) */
    .builder-area { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .field-config-card { border-left: 4px solid #198754; background: #fdfdfd; padding: 10px; margin-bottom: 10px; position: relative; }
    .btn-delete-field { position: absolute; top: 5px; right: 5px; color: #dc3545; background: none; border: none; }
</style>
</head>
<body>

<header>
  <h1>CRM RCF</h1>
  <span class="text-white small">Mobile v4.0 Pro</span>
</header>

<nav id="mainNav">
  <a class="navbtn active" href="#" onclick="mostrarTela('tela-inicio', this)"><i class="fas fa-home"></i><br/>In√≠cio</a>
  <a class="navbtn" href="#" onclick="mostrarTela('tela-clientes', this)"><i class="fas fa-user"></i><br/>Clientes</a>
  <a class="navbtn" href="#" onclick="mostrarTela('tela-agenda', this)"><i class="fas fa-calendar-alt"></i><br/>Agenda</a>
  <a class="navbtn" href="#" onclick="mostrarTela('tela-albuns', this)"><i class="fas fa-book-open"></i><br/>√Ålbuns</a>
  <a class="navbtn" href="#" onclick="mostrarTela('tela-financeiro', this)"><i class="fas fa-dollar-sign"></i><br/>Financeiro</a>
  <a class="navbtn" href="#" onclick="mostrarTela('tela-ferramentas', this)"><i class="fas fa-cogs"></i><br/>Builder</a>
  <a class="navbtn" href="#" onclick="mostrarTela('tela-extra1', this)"><i class="fas fa-envelope"></i><br/>Msgs</a>
  </nav>

<main class="container py-3">

  <div id="tela-inicio">
    <h5 class="mb-3">üìÖ Pr√≥ximos Agendamentos</h5>
    
    <div class="d-flex justify-content-between align-items-center mb-2">
      <button class="btn btn-sm btn-outline-secondary" onclick="mudarMes(-1)">‚óÄ</button>
      <span id="mesAtualLabel" class="fw-bold"></span>
      <button class="btn btn-sm btn-outline-secondary" onclick="mudarMes(1)">‚ñ∂</button>
    </div>

    <div id="eventosDoDia" class="alert alert-info py-2" style="display:none; font-size: 0.8rem;"></div>
    <div id="calendarioAgendamentos" class="mb-3"></div>

    <div class="legenda">
      <div class="legenda-item"><div class="legenda-bolinha cal-verde"></div> Infantil/Fam√≠lia</div>
      <div class="legenda-item"><div class="legenda-bolinha cal-azul"></div> Anivers√°rio</div>
      <div class="legenda-item"><div class="legenda-bolinha cal-roxo"></div> Gestante</div>
      <div class="legenda-item"><div class="legenda-bolinha cal-laranja"></div> Smash</div>
    </div>
    <hr>
    <div class="d-flex justify-content-end gap-2 mb-2">
        <button class="btn btn-sm btn-outline-dark" onclick="toggleAgendamentos()" id="botaoToggleAgendamentos">üëÅÔ∏è Ocultar Lista</button>
    </div>
    <ul class="list-group small mb-4" id="listaProximosAgendamentos">
      <li class="list-group-item">Carregando...</li>
    </ul>
    <div class="card bg-light">
        <div class="card-body p-2">
            <h6 class="card-title small">üîç Buscar Agendamento</h6>
            <input class="form-control form-control-sm" oninput="buscarAgendamentosPorNome(this.value)" placeholder="Digite o nome do cliente..." type="text"/>
            <ul class="list-group mt-2" id="resultadosPorNome"></ul>
        </div>
    </div>
  </div>

  <div id="tela-clientes" style="display:none;">
    <h5 class="mb-3 d-flex justify-content-between align-items-center">
      üë§ Gest√£o de Clientes
      <button class="btn btn-sm btn-outline-success" onclick="toggleImportacaoTexto()">üìã Importar</button>
    </h5>

    <div id="areaImportacao" class="card mb-3 p-2 bg-light" style="display:none;">
        <textarea class="form-control form-control-sm mb-2" id="campoTextoImportacao" placeholder="Cole o texto do WhatsApp aqui..." rows="3"></textarea>
        <button class="btn btn-success btn-sm w-100" onclick="importarClientePorTexto()">Processar Texto</button>
    </div>

    <div class="row g-2 mb-3">
        <div class="col-4">
            <label class="form-label">ID (Auto)</label>
            <input class="form-control" id="buscarIdCliente" placeholder="Novo" disabled type="text"/>
        </div>
        <div class="col-8">
            <label class="form-label">Buscar por Nome</label>
            <input class="form-control" id="buscarNomeCliente" list="sugestoesClientes" onchange="preencherClientePorNome(this.value)" placeholder="Digite para buscar..." type="text"/>
            <datalist id="sugestoesClientes"></datalist>
        </div>
    </div>

    <form onsubmit="event.preventDefault(); salvarCliente();">
        <div class="mb-2">
            <label class="form-label">Nome Completo</label>
            <input class="form-control" id="nomeCliente" required type="text"/>
        </div>
        <div class="mb-2">
            <label class="form-label">Instagram</label>
            <input class="form-control" id="instagramCliente" type="text"/>
        </div>
        <div class="row g-2 mb-2">
            <div class="col-8">
                <label class="form-label">Nome Filho(a)</label>
                <input class="form-control" id="filhoCliente" type="text"/>
            </div>
            <div class="col-4">
                <label class="form-label">Idade</label>
                <input class="form-control" id="idadeCliente" type="number"/>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Postagem Autorizada?</label>
            <select class="form-select" id="postagemCliente">
                <option value="Sim">Sim</option>
                <option value="N√£o">N√£o</option>
            </select>
        </div>
        
        <div class="d-grid gap-2">
            <button class="btn btn-primary" type="submit">üíæ Salvar Cliente</button>
            <button class="btn btn-outline-secondary" type="button" onclick="limparFormularioCliente()">Limpar Campos</button>
        </div>
    </form>
    <hr class="my-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="m-0">Lista de Clientes</h6>
        <div>
            <button class="btn btn-sm btn-outline-dark" onclick="ordenarClientesPorNome()">A-Z</button>
            <button class="btn btn-sm btn-outline-dark" onclick="ordenarClientesPorID()">1-9</button>
        </div>
    </div>
    <ul class="list-group small" id="listaClientes"></ul>
  </div>

  <div id="tela-agenda" style="display:none;">
    <h5 class="mb-3">üóìÔ∏è Novo Agendamento</h5>
    
    <div class="row g-2 mb-3">
        <div class="col-4">
            <label class="form-label">Buscar ID</label>
            <input class="form-control" id="buscaIdClienteAgenda" oninput="selecionarClientePorID(this.value)" placeholder="ID" type="number"/>
        </div>
        <div class="col-8">
            <label class="form-label">Selecione o Cliente</label>
            <select class="form-select" id="idClienteSelect">
                <option value="">Carregando clientes...</option>
            </select>
        </div>
    </div>

    <div class="row g-2 mb-2">
        <div class="col-12">
            <label class="form-label">Data</label>
            <input class="form-control" id="dataAgenda" type="date"/>
        </div>
        <div class="col-6">
            <label class="form-label">In√≠cio</label>
            <input class="form-control" id="horaInicio" type="time"/>
        </div>
        <div class="col-6">
            <label class="form-label">Fim</label>
            <input class="form-control" id="horaFim" type="time"/>
        </div>
    </div>
    <div class="mb-2">
        <label class="form-label">Tipo de Sess√£o</label>
        <select class="form-select" id="tipoSessao">
            <option value="">Selecione...</option>
            <option value="Anivers√°rio">Anivers√°rio</option>
            <option value="Ensaio Infantil">Ensaio Infantil</option>
            <option value="Debutante">Debutante</option>
            <option value="Ensaio Gestante">Ensaio Gestante</option>
            <option value="Ensaio Casual">Ensaio Casual</option>
            <option value="Ensaio Fam√≠lia">Ensaio Fam√≠lia</option>
            <option value="Smash The Cake">Smash The Cake</option>
        </select>
    </div>
    <div class="mb-2">
        <label class="form-label">Tema / Obs</label>
        <input class="form-control" id="temaSessao" type="text"/>
    </div>
    <div class="card p-3 bg-light mb-3">
        <h6 class="text-success">Financeiro do Evento</h6>
        <div class="mb-2">
            <label class="form-label">Pacote Escolhido</label>
            <select class="form-select" id="pacoteSessao">
                <optgroup label="Fotos Individuais">
                    <option value="10 fotos">10 fotos</option>
                    <option value="15 fotos">15 fotos</option>
                    <option value="20 fotos">20 fotos</option>
                    <option value="30 fotos">30 fotos</option>
                </optgroup>
                <optgroup label="Cobertura de Evento">
                    <option value="Pr√© Festa">Pr√© Festa</option>
                    <option value="Cobertura 2h">Cobertura 2h</option>
                    <option value="Cobertura 3h">Cobertura 3h</option>
                </optgroup>
                <optgroup label="Cobertura + √Ålbum">
                    <option value="Cobertura 2h + √Ålbum">Cobertura 2h + √Ålbum</option>
                    <option value="Cobertura 3h + √Ålbum">Cobertura 3h + √Ålbum</option>
                </optgroup>
            </select>
        </div>
        <div class="row g-2">
            <div class="col-4">
                <label class="form-label">Total (R$)</label>
                <input class="form-control" id="valorPacote" type="number" step="0.01" oninput="atualizarRestante()"/>
            </div>
            <div class="col-4">
                <label class="form-label">Sinal (R$)</label>
                <input class="form-control" id="reservaValor" type="number" step="0.01" oninput="atualizarRestante()"/>
            </div>
            <div class="col-4">
                <label class="form-label">No Dia (R$)</label>
                <input class="form-control" id="valorNoDia" type="number" readonly/>
            </div>
        </div>
    </div>
    <div class="d-grid">
        <button class="btn btn-success btn-lg" onclick="agendar()">Confirmar Agendamento</button>
    </div>
  </div>

  <div id="tela-albuns" style="display:none;">
    <h5 class="mb-3">üìö Controle de √Ålbuns</h5>
    <div class="card p-3 mb-3">
        <div class="mb-2">
            <label class="form-label">Cliente (ID - Nome)</label>
            <select class="form-select" id="idClienteAlbumSelect"></select>
        </div>
        <div class="row g-2 mb-3">
            <div class="col-6">
                <label class="form-label">Tipo</label>
                <select class="form-select" id="tipoAlbum">
                    <option value="Tradicional">Tradicional</option>
                    <option value="Premium">Premium</option>
                    <option value="Super Premium">Super Premium</option>
                </select>
            </div>
            <div class="col-6">
                <label class="form-label">Fase</label>
                <select class="form-select" id="faseAlbum">
                    <option value="Sele√ß√£o enviada">Sele√ß√£o enviada</option>
                    <option value="Aguardando sele√ß√£o">Aguardando sele√ß√£o</option>
                    <option value="Em diagrama√ß√£o">Em diagrama√ß√£o</option>
                    <option value="Em confec√ß√£o">Em confec√ß√£o</option>
                    <option value="Pronto">Pronto para entrega</option>
                </select>
            </div>
        </div>
        <button class="btn btn-primary w-100" onclick="salvarAlbum()">Atualizar Status</button>
    </div>
    <h6>√Ålbuns em Andamento</h6>
    <ul class="list-group small" id="listaAlbuns"></ul>
  </div>

  <div id="tela-financeiro" style="display:none;">
    <h5 class="mb-3">üí∞ Dashboard Financeiro</h5>
    <div class="btn-group w-100 mb-3">
        <button class="btn btn-outline-primary active" onclick="exibirDashboardFinanceiro()">Resumo</button>
        <button class="btn btn-outline-secondary" onclick="gerarRelatorioDespesas()">Extrato</button>
    </div>
    <div id="resultadoRelatorio"></div>
  </div>

  <div id="tela-ferramentas" style="display:none;">
    <h5 class="mb-3">üõ†Ô∏è Construtor de M√≥dulos (Builder)</h5>
    <p class="small text-muted">Crie novas abas e formul√°rios complexos para seu CRM.</p>

    <ul class="nav nav-tabs mb-3" id="builderTab">
        <li class="nav-item">
            <a class="nav-link active" onclick="switchBuilderTab('gerenciar')" href="#">Gerenciar Abas</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" onclick="switchBuilderTab('criar')" href="#">‚ûï Nova Aba</a>
        </li>
    </ul>

    <div id="builder-gerenciar">
        <div id="listaModulosCriados" class="list-group">
            </div>
    </div>

    <div id="builder-criar" style="display:none;">
        <div class="builder-area">
            <h6 class="text-primary border-bottom pb-2">1. Configura√ß√£o da Aba</h6>
            <div class="mb-2">
                <label class="form-label small">Nome da Aba (Ex: Fornecedores)</label>
                <input type="text" id="builderNomeModulo" class="form-control" placeholder="Nome no Menu">
            </div>
            <div class="mb-2">
                <label class="form-label small">√çcone (FontAwesome)</label>
                <div class="input-group">
                    <span class="input-group-text">fa-</span>
                    <input type="text" id="builderIconeModulo" class="form-control" placeholder="box, truck, star...">
                </div>
            </div>
            
            <h6 class="text-primary border-bottom pb-2 mt-4">2. Estrutura de Campos</h6>
            <div id="builderAreaCampos">
                </div>

            <div class="d-flex gap-2 mt-3 overflow-auto pb-2">
                <button class="btn btn-sm btn-outline-dark text-nowrap" onclick="addBuilderField('text')">+ Texto</button>
                <button class="btn btn-sm btn-outline-dark text-nowrap" onclick="addBuilderField('number')">+ N√∫mero</button>
                <button class="btn btn-sm btn-outline-success text-nowrap" onclick="addBuilderField('money')">+ R$ Moeda</button>
                <button class="btn btn-sm btn-outline-dark text-nowrap" onclick="addBuilderField('date')">+ Data</button>
                <button class="btn btn-sm btn-outline-dark text-nowrap" onclick="addBuilderField('select')">+ Lista</button>
                <button class="btn btn-sm btn-outline-dark text-nowrap" onclick="addBuilderField('multiselect')">+ Checkbox</button>
                <button class="btn btn-sm btn-outline-warning text-dark text-nowrap" onclick="addBuilderField('formula')">+ F√≥rmula ùëì(x)</button>
            </div>

            <hr>
            <div class="d-grid">
                <button class="btn btn-success" onclick="salvarNovoModulo()">üíæ Salvar e Criar Aba</button>
                <button class="btn btn-outline-secondary mt-2" onclick="cancelarEdicaoModulo()">Cancelar</button>
            </div>
        </div>
    </div>

    <hr class="my-4">
    <h6 class="mb-2">Backup & Dados</h6>
    <div class="row g-2">
        <div class="col-6">
            <button class="btn btn-light border w-100 py-2 small" onclick="exportarBackup()">
                <i class="fas fa-download"></i> Baixar Dados
            </button>
        </div>
        <div class="col-6">
             <label class="btn btn-light border w-100 py-2 small" style="cursor: pointer;">
                <input type="file" hidden accept=".json" onchange="importarBackup(event)">
                <i class="fas fa-upload"></i> Restaurar
            </label>
        </div>
    </div>
  </div>

  <div id="tela-extra1" style="display:none;">
    <h5 class="mb-3">üì© Gerador de Mensagens</h5>
    <div class="card p-3 mb-3 bg-white">
        <h6>Confirma√ß√£o de Agendamento</h6>
        <div class="input-group mb-2">
            <input class="form-control" id="idAgendamentoTexto" placeholder="ID do Agendamento" type="number"/>
            <button class="btn btn-outline-primary" onclick="gerarTextoWhatsAppPorID()">Gerar</button>
        </div>
        <textarea class="form-control form-control-sm mb-2" id="mensagemWhatsTexto" rows="8"></textarea>
        <button class="btn btn-success btn-sm w-100" onclick="copiarTexto('mensagemWhatsTexto')">Copiar para WhatsApp</button>
    </div>
  </div>

  <div id="tela-dinamica-container" style="display:none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 id="titulo-dinamico">M√≥dulo</h5>
          <button class="btn btn-sm btn-primary" onclick="alternarFormularioDinamico()">+ Novo</button>
      </div>

      <div id="form-dinamico-wrapper" class="card p-3 bg-light mb-4 shadow-sm" style="display:none;">
          <h6 class="text-success mb-3">Novo Registro</h6>
          <form id="form-dinamico" onsubmit="event.preventDefault(); salvarRegistroDinamico();">
              <div id="campos-dinamicos-area" class="row g-2"></div>
              <div class="d-flex gap-2 mt-3">
                  <button type="submit" class="btn btn-success flex-grow-1">Salvar</button>
                  <button type="button" class="btn btn-secondary" onclick="alternarFormularioDinamico()">Cancelar</button>
              </div>
          </form>
      </div>

      <div class="card">
          <div class="card-header bg-white fw-bold small">Registros Salvos</div>
          <ul class="list-group list-group-flush small" id="lista-dinamica-registros"></ul>
      </div>
  </div>

</main>

<div class="modal fade" id="finalizarModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Finalizar Sess√£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="finalizarId">
        <div class="mb-2">
            <label>Gastos Uber/Transporte</label>
            <input class="form-control" type="number" id="finalizarUber" value="0">
        </div>
        <div class="mb-2">
            <label>Custo √Ålbum/Laborat√≥rio</label>
            <input class="form-control" type="number" id="finalizarAlbum" value="0">
        </div>
        <div class="mb-2">
            <label>Outras Despesas</label>
            <input class="form-control" type="number" id="finalizarOutras" value="0">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" onclick="salvarDespesasEFinalizar()">Concluir</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
/**
 * ====================================================================
 * SISTEMA CENTRALIZADO CRM RCF v4.0 (Builder Edition)
 * ====================================================================
 */

// --- DADOS B√ÅSICOS & STORAGE ---
function getDados(chave) { return JSON.parse(localStorage.getItem(chave)) || []; }
function setDados(chave, dados) { localStorage.setItem(chave, JSON.stringify(dados)); }

// Estrutura de M√≥dulos Personalizados
// custom_modules = [{ id: 'mod_123', nome: 'Fornecedores', icone: 'truck', campos: [...] }]
// custom_data_mod_123 = [{ id: 1, campo_a: 'valor', ... }]

// --- NAVEGA√á√ÉO ---
let moduloAtualId = null;

function mostrarTela(id, btn) {
    // Esconde todas as telas fixas
    document.querySelectorAll("main > div").forEach(t => t.style.display = 'none');
    // Mostra a selecionada
    const tela = document.getElementById(id);
    if(tela) tela.style.display = 'block';

    // Atualiza Bot√µes
    if(btn) {
        document.querySelectorAll('.navbtn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // L√≥gica Espec√≠fica
    if(id === 'tela-inicio') { renderizarCalendario(); listarProximos(); }
    if(id === 'tela-clientes') listarClientes();
    if(id === 'tela-agenda') carregarClientesSelect();
    if(id === 'tela-albuns') { carregarClientesSelect(); listarAlbuns(); }
    if(id === 'tela-financeiro') exibirDashboardFinanceiro();
    if(id === 'tela-ferramentas') carregarListaModulosBuilder();
}

// Inicializa√ß√£o
window.onload = function() {
    renderizarNavegacaoExtra(); // Carrega as abas personalizadas
    mostrarTela('tela-inicio');
};

/* =================================================================================
   M√ìDULO BUILDER (FERRAMENTAS) - CRIA√á√ÉO DE TELAS
   ================================================================================= */
let camposTemporariosBuilder = [];

function switchBuilderTab(tab) {
    document.getElementById('builder-gerenciar').style.display = tab === 'gerenciar' ? 'block' : 'none';
    document.getElementById('builder-criar').style.display = tab === 'criar' ? 'block' : 'none';
    
    // Toggle active class bootstrap
    document.querySelectorAll('#builderTab .nav-link').forEach(l => l.classList.remove('active'));
    event.target.classList.add('active');

    if(tab === 'criar') iniciarNovoModulo();
    else carregarListaModulosBuilder();
}

function iniciarNovoModulo() {
    document.getElementById('builderNomeModulo').value = '';
    document.getElementById('builderIconeModulo').value = '';
    document.getElementById('builderAreaCampos').innerHTML = '<p class="text-center text-muted small my-3">Nenhum campo adicionado. Use os bot√µes abaixo.</p>';
    camposTemporariosBuilder = [];
}

function carregarListaModulosBuilder() {
    const lista = document.getElementById('listaModulosCriados');
    const modulos = getDados('custom_modules');
    lista.innerHTML = '';

    if(modulos.length === 0) {
        lista.innerHTML = '<div class="alert alert-warning small">Nenhuma aba personalizada criada. Clique em "+ Nova Aba".</div>';
        return;
    }

    modulos.forEach(mod => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.innerHTML = `
            <div>
                <i class="fas fa-${mod.icone} me-2 text-success"></i> <strong>${mod.nome}</strong>
                <br><small class="text-muted">${mod.campos.length} campos configurados</small>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="excluirModulo('${mod.id}')"><i class="fas fa-trash"></i></button>
        `;
        lista.appendChild(item);
    });
}

// Adiciona um campo visualmente no Builder
function addBuilderField(type) {
    // Remove msg vazia se existir
    const area = document.getElementById('builderAreaCampos');
    if(area.querySelector('p')) area.innerHTML = '';

    const idTemp = 'field_' + Date.now();
    const div = document.createElement('div');
    div.className = 'field-config-card';
    div.id = `card_${idTemp}`;
    
    let htmlExtra = '';
    
    // Configura√ß√µes Espec√≠ficas por Tipo
    if(type === 'select' || type === 'multiselect') {
        htmlExtra = `
            <div class="mt-2">
                <label class="small text-muted">Op√ß√µes (separadas por v√≠rgula)</label>
                <input type="text" class="form-control form-control-sm field-options" placeholder="Ex: Pendente, Pago, Cancelado">
            </div>
        `;
    }
    
    if(type === 'money') {
        htmlExtra = `
            <div class="mt-2 form-check">
                <input class="form-check-input field-finance" type="checkbox" id="chk_${idTemp}">
                <label class="form-check-label small" for="chk_${idTemp}">Lan√ßar no Financeiro?</label>
            </div>
            <div class="mt-1" id="fin_type_${idTemp}" style="display:none;">
                <select class="form-select form-select-sm field-finance-type">
                    <option value="despesa">Como Despesa (Sa√≠da)</option>
                    <option value="receita">Como Receita (Entrada)</option>
                </select>
            </div>
        `;
    }

    if(type === 'formula') {
        htmlExtra = `
            <div class="mt-2 bg-light p-2 border rounded">
                <label class="small fw-bold">F√≥rmula Matem√°tica</label>
                <input type="text" class="form-control form-control-sm field-formula" placeholder="Ex: val_unitario * quantidade">
                <small class="text-muted d-block mt-1" style="font-size:0.7rem">
                    Use os nomes das vari√°veis (definidos acima) para calcular. Ex: Se voc√™ criou um campo com nome de vari√°vel "custo" e outro "qtd", digite: <code>custo * qtd</code>.
                </small>
            </div>
        `;
    }

    div.innerHTML = `
        <button class="btn-delete-field" onclick="removeBuilderField('${idTemp}')"><i class="fas fa-times"></i></button>
        <div class="row g-2">
            <div class="col-8">
                <label class="small fw-bold">R√≥tulo (Label)</label>
                <input type="text" class="form-control form-control-sm field-label" placeholder="Ex: Valor Unit√°rio">
            </div>
            <div class="col-4">
                <label class="small fw-bold">Tipo</label>
                <input type="text" class="form-control form-control-sm bg-light" value="${type}" disabled>
                <input type="hidden" class="field-type" value="${type}">
            </div>
            <div class="col-12">
                <label class="small text-muted">Nome Vari√°vel (sem espa√ßos)</label>
                <input type="text" class="form-control form-control-sm field-var" placeholder="Ex: val_unitario">
            </div>
        </div>
        ${htmlExtra}
    `;

    area.appendChild(div);

    // Listener para o Checkbox Financeiro
    if(type === 'money') {
        setTimeout(() => {
            document.getElementById(`chk_${idTemp}`).addEventListener('change', function() {
                document.getElementById(`fin_type_${idTemp}`).style.display = this.checked ? 'block' : 'none';
            });
        }, 100);
    }
}

function removeBuilderField(id) {
    document.getElementById(`card_${id}`).remove();
}

function salvarNovoModulo() {
    const nome = document.getElementById('builderNomeModulo').value.trim();
    const icone = document.getElementById('builderIconeModulo').value.trim() || 'cube';
    
    if(!nome) return alert("Defina um nome para a aba.");

    // Coletar Campos
    const cards = document.querySelectorAll('.field-config-card');
    const campos = [];

    cards.forEach(card => {
        const label = card.querySelector('.field-label').value;
        const variable = card.querySelector('.field-var').value;
        const type = card.querySelector('.field-type').value;
        
        if(!label || !variable) return; // Pula vazios

        let config = { label, variable, type };

        // Op√ß√µes para Selects
        if(card.querySelector('.field-options')) {
            config.options = card.querySelector('.field-options').value.split(',').map(s => s.trim());
        }

        // Configura√ß√£o Financeira
        if(card.querySelector('.field-finance') && card.querySelector('.field-finance').checked) {
            config.finance = true;
            config.financeType = card.querySelector('.field-finance-type').value;
        }

        // Configura√ß√£o F√≥rmula
        if(card.querySelector('.field-formula')) {
            config.formula = card.querySelector('.field-formula').value;
        }

        campos.push(config);
    });

    if(campos.length === 0) return alert("Adicione pelo menos um campo.");

    const modulos = getDados('custom_modules');
    const novoId = 'mod_' + Date.now();
    
    modulos.push({
        id: novoId,
        nome: nome,
        icone: icone,
        campos: campos
    });

    setDados('custom_modules', modulos);
    
    alert(`M√≥dulo "${nome}" criado com sucesso! A p√°gina ser√° recarregada para atualizar o menu.`);
    location.reload(); 
}

function excluirModulo(id) {
    if(confirm("Tem certeza? Todos os dados desta aba ser√£o perdidos para sempre.")) {
        let modulos = getDados('custom_modules');
        modulos = modulos.filter(m => m.id !== id);
        setDados('custom_modules', modulos);
        localStorage.removeItem('custom_data_' + id); // Remove dados associados
        location.reload();
    }
}

/* =================================================================================
   MOTOR DE RENDERIZA√á√ÉO DIN√ÇMICA (GEN√âRICO)
   ================================================================================= */

function renderizarNavegacaoExtra() {
    const nav = document.getElementById('mainNav');
    const modulos = getDados('custom_modules');
    
    modulos.forEach(mod => {
        const a = document.createElement('a');
        a.className = 'navbtn';
        a.href = '#';
        a.innerHTML = `<i class="fas fa-${mod.icone}"></i><br/>${mod.nome}`;
        a.onclick = function() {
            carregarTelaDinamica(mod.id, this);
        };
        nav.appendChild(a);
    });
}

function carregarTelaDinamica(modId, btnElement) {
    // UI Change
    document.querySelectorAll("main > div").forEach(t => t.style.display = 'none');
    document.querySelectorAll('.navbtn').forEach(b => b.classList.remove('active'));
    
    const container = document.getElementById('tela-dinamica-container');
    container.style.display = 'block';
    if(btnElement) btnElement.classList.add('active');

    moduloAtualId = modId;
    const modulos = getDados('custom_modules');
    const modConfig = modulos.find(m => m.id === modId);

    if(!modConfig) return alert("Erro ao carregar m√≥dulo.");

    document.getElementById('titulo-dinamico').innerHTML = `<i class="fas fa-${modConfig.icone} me-2"></i> ${modConfig.nome}`;
    
    // Reset Form Display
    document.getElementById('form-dinamico-wrapper').style.display = 'none';
    
    // Renderizar Lista
    listarRegistrosDinamicos(modConfig);

    // Preparar Formul√°rio (mas manter escondido)
    construirFormularioDinamico(modConfig);
}

function alternarFormularioDinamico() {
    const form = document.getElementById('form-dinamico-wrapper');
    const isVisible = form.style.display === 'block';
    
    if(!isVisible) {
        // Limpar campos ao abrir
        document.getElementById('form-dinamico').reset();
    }
    form.style.display = isVisible ? 'none' : 'block';
}

function construirFormularioDinamico(config) {
    const area = document.getElementById('campos-dinamicos-area');
    area.innerHTML = '';

    config.campos.forEach(campo => {
        let inputHtml = '';
        const idCampo = `field_input_${campo.variable}`;

        if(campo.type === 'text') {
            inputHtml = `<input type="text" class="form-control" id="${idCampo}" name="${campo.variable}">`;
        } else if (campo.type === 'number') {
            inputHtml = `<input type="number" step="any" class="form-control formula-trigger" id="${idCampo}" name="${campo.variable}">`;
        } else if (campo.type === 'money') {
            inputHtml = `
                <div class="input-group">
                    <span class="input-group-text">R$</span>
                    <input type="number" step="0.01" class="form-control formula-trigger" id="${idCampo}" name="${campo.variable}">
                </div>`;
        } else if (campo.type === 'date') {
            inputHtml = `<input type="date" class="form-control" id="${idCampo}" name="${campo.variable}">`;
        } else if (campo.type === 'select') {
            let opts = campo.options.map(o => `<option value="${o}">${o}</option>`).join('');
            inputHtml = `<select class="form-select" id="${idCampo}" name="${campo.variable}"><option value="">Selecione...</option>${opts}</select>`;
        } else if (campo.type === 'multiselect') {
            let checks = campo.options.map(o => `
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="${campo.variable}" value="${o}">
                    <label class="form-check-label small">${o}</label>
                </div>
            `).join('');
            inputHtml = `<div>${checks}</div>`;
        } else if (campo.type === 'formula') {
            inputHtml = `<input type="text" class="form-control bg-light fw-bold" id="${idCampo}" name="${campo.variable}" readonly placeholder="Calculado automaticamente...">`;
        }

        const div = document.createElement('div');
        div.className = 'col-12';
        if(campo.type === 'number' || campo.type === 'money' || campo.type === 'date') div.className = 'col-6';
        
        div.innerHTML = `<label class="form-label small">${campo.label}</label>${inputHtml}`;
        area.appendChild(div);
    });

    // Adiciona Listeners para F√≥rmulas
    const triggers = document.querySelectorAll('.formula-trigger');
    triggers.forEach(t => t.addEventListener('input', () => recalcularFormulas(config)));
}

function recalcularFormulas(config) {
    // 1. Pega valores atuais
    let valores = {};
    config.campos.forEach(c => {
        if(c.type === 'number' || c.type === 'money') {
            const el = document.getElementById(`field_input_${c.variable}`);
            valores[c.variable] = parseFloat(el.value) || 0;
        }
    });

    // 2. Processa campos de f√≥rmula
    config.campos.filter(c => c.type === 'formula').forEach(f => {
        let expressao = f.formula;
        // Substituir variaveis pelos valores
        for (const [key, val] of Object.entries(valores)) {
            // Regex simples para substituir palavra exata
            const regex = new RegExp(`\\b${key}\\b`, 'g');
            expressao = expressao.replace(regex, val);
        }

        try {
            // Eval seguro apenas para matem√°tica simples
            // Remove caracteres perigosos, deixa so numeros e operadores
            const sanitized = expressao.replace(/[^0-9+\-*/(). ]/g, '');
            const resultado = eval(sanitized); 
            document.getElementById(`field_input_${f.variable}`).value = isNaN(resultado) ? 0 : resultado.toFixed(2);
        } catch (e) {
            console.error("Erro na formula", e);
        }
    });
}

function salvarRegistroDinamico() {
    const modulos = getDados('custom_modules');
    const config = modulos.find(m => m.id === moduloAtualId);
    
    let registro = { id: Date.now() };
    let financeiroUpdate = []; // Lista de updates financeiros

    // Coleta dados
    config.campos.forEach(c => {
        const el = document.getElementById(`field_input_${c.variable}`);
        if(!el && c.type !== 'multiselect') return;

        if(c.type === 'multiselect') {
            const checks = document.querySelectorAll(`input[name="${c.variable}"]:checked`);
            registro[c.variable] = Array.from(checks).map(cb => cb.value).join(', ');
        } else {
            registro[c.variable] = el.value;
            
            // L√≥gica Financeira Integrada
            if(c.type === 'money' && c.finance) {
                const valor = parseFloat(el.value) || 0;
                if(valor > 0) {
                    financeiroUpdate.push({
                        tipo: c.financeType,
                        valor: valor,
                        descricao: `${config.nome}: ${c.label}`
                    });
                }
            }
        }
    });

    // Salva Registro do M√≥dulo
    const keyData = 'custom_data_' + moduloAtualId;
    let dados = getDados(keyData);
    dados.push(registro);
    setDados(keyData, dados);

    // Processa Integra√ß√£o Financeira
    if(financeiroUpdate.length > 0) {
        let despesas = getDados('despesas'); // Vamos usar a mesma estrutura ou adaptar
        // Nota: O sistema original s√≥ tinha "despesas" com estrutura fixa.
        // Vamos adaptar: se for Receita, vamos colocar como "valorPacote" em um agendamento fict√≠cio ou criar uma estrutura 'extrato_financeiro' melhor.
        // PARA MANTER COMPATIBILIDADE: Vamos salvar como Despesa no array 'despesas' se for despesa.
        // Se for receita, o dashboard atual s√≥ l√™ agendamentos. Vou injetar no array 'agendamentos' como um item 'Extra'.
        
        financeiroUpdate.forEach(item => {
            if(item.tipo === 'despesa') {
                despesas.push({
                    idAgendamento: 'MOD_' + registro.id,
                    data: new Date().toISOString().split('T')[0],
                    uber: 0, album: 0, outras: item.valor, // Joga em 'outras'
                    total: item.valor
                });
            } else {
                // Hack para Receita: Cria um agendamento 'fake' finalizado que conta como receita
                let agendamentos = getDados('agendamentos');
                agendamentos.push({
                    id: 99000 + Math.floor(Math.random() * 1000), // ID alto para n√£o conflitar
                    idCliente: '0',
                    nome: item.descricao, // Ex: Venda Produto X
                    data: new Date().toISOString().split('T')[0],
                    hora: '00:00', fim: '00:00',
                    tipo: 'Receita Extra',
                    pacote: 'M√≥dulo Personalizado',
                    valorPacote: item.valor, // Conta como receita total
                    reserva: 0, valorDia: 0,
                    status: 'Finalizado' // Para n√£o aparecer na agenda mas contar no financeiro
                });
                setDados('agendamentos', agendamentos);
            }
        });
        setDados('despesas', despesas);
    }

    alert("Registro salvo com sucesso!");
    alternarFormularioDinamico();
    listarRegistrosDinamicos(config);
}

function listarRegistrosDinamicos(config) {
    const keyData = 'custom_data_' + config.id;
    const dados = getDados(keyData).reverse(); // Mais recentes primeiro
    const lista = document.getElementById('lista-dinamica-registros');
    lista.innerHTML = '';

    if(dados.length === 0) {
        lista.innerHTML = '<li class="list-group-item text-muted text-center py-3">Nenhum registro encontrado.</li>';
        return;
    }

    dados.forEach(d => {
        // Tenta achar o primeiro campo de texto para ser o t√≠tulo
        const campoTitulo = config.campos.find(c => c.type === 'text') || config.campos[0];
        const titulo = d[campoTitulo.variable] || 'Registro #' + d.id;

        // Monta resumo dos valores
        let detalhes = config.campos.map(c => {
            if(c.variable === campoTitulo.variable) return null;
            let val = d[c.variable];
            if(c.type === 'money') val = `R$ ${parseFloat(val||0).toFixed(2)}`;
            return `<span class="badge bg-light text-dark border me-1">${c.label}: ${val}</span>`;
        }).filter(x => x).join('');

        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.innerHTML = `
            <div class="d-flex justify-content-between">
                <span class="fw-bold">${titulo}</span>
                <button class="btn btn-sm text-danger" onclick="excluirRegistroDinamico('${config.id}', ${d.id})">&times;</button>
            </div>
            <div class="mt-1">${detalhes}</div>
        `;
        lista.appendChild(li);
    });
}

function excluirRegistroDinamico(modId, regId) {
    if(confirm("Excluir este registro?")) {
        const key = 'custom_data_' + modId;
        let dados = getDados(key);
        dados = dados.filter(d => d.id !== regId);
        setDados(key, dados);
        
        // Recarrega lista
        const modulos = getDados('custom_modules');
        const config = modulos.find(m => m.id === modId);
        listarRegistrosDinamicos(config);
    }
}


/* =================================================================================
   FUN√á√ïES ORIGINAIS DO SISTEMA (MANTIDAS)
   ================================================================================= */
// --- CLIENTES ---
function salvarCliente() {
    const nome = document.getElementById("nomeCliente").value.trim();
    if(!nome) return alert("Nome √© obrigat√≥rio");

    let clientes = getDados("clientes");
    const idBusca = document.getElementById("buscarIdCliente").value; 
    const novoId = clientes.length > 0 ? Math.max(...clientes.map(c => parseInt(c.id))) + 1 : 1;
    
    const cliente = {
        id: idBusca || novoId.toString(),
        nome: nome,
        instagram: document.getElementById("instagramCliente").value,
        filho: document.getElementById("filhoCliente").value,
        idade: document.getElementById("idadeCliente").value,
        postagem: document.getElementById("postagemCliente").value
    };

    if(idBusca) {
        const index = clientes.findIndex(c => c.id == idBusca);
        if(index > -1) clientes[index] = cliente;
    } else {
        clientes.push(cliente);
    }

    setDados("clientes", clientes);
    alert("Cliente salvo!");
    limparFormularioCliente();
    listarClientes();
}

function listarClientes() {
    const lista = document.getElementById("listaClientes");
    lista.innerHTML = "";
    const clientes = getDados("clientes").sort((a,b) => a.nome.localeCompare(b.nome));

    clientes.forEach(c => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
            <div onclick="carregarClienteNoForm('${c.id}')" style="cursor:pointer; flex:1;">
                <strong>${c.nome}</strong> <small class="text-muted">#${c.id}</small><br>
                <small>${c.filho ? 'Filho(a): ' + c.filho : 'Sem dados filho'}</small>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="excluirCliente('${c.id}')"><i class="fas fa-trash"></i></button>
        `;
        lista.appendChild(li);
    });

    const datalist = document.getElementById("sugestoesClientes");
    datalist.innerHTML = "";
    clientes.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.nome;
        datalist.appendChild(opt);
    });
}

function carregarClienteNoForm(id) {
    const clientes = getDados("clientes");
    const c = clientes.find(x => x.id == id);
    if(c) {
        document.getElementById("buscarIdCliente").value = c.id;
        document.getElementById("nomeCliente").value = c.nome;
        document.getElementById("instagramCliente").value = c.instagram;
        document.getElementById("filhoCliente").value = c.filho;
        document.getElementById("idadeCliente").value = c.idade;
        document.getElementById("postagemCliente").value = c.postagem;
        document.getElementById("tela-clientes").scrollIntoView();
    }
}

function preencherClientePorNome(nome) {
    const clientes = getDados("clientes");
    const c = clientes.find(x => x.nome === nome);
    if(c) carregarClienteNoForm(c.id);
}

function limparFormularioCliente() {
    document.querySelector("form").reset();
    document.getElementById("buscarIdCliente").value = "";
}

function excluirCliente(id) {
    if(confirm("Confirma exclus√£o?")) {
        let clientes = getDados("clientes");
        clientes = clientes.filter(c => c.id != id);
        setDados("clientes", clientes);
        listarClientes();
    }
}

function importarClientePorTexto() {
    const texto = document.getElementById("campoTextoImportacao").value;
    const linhas = texto.split('\n');
    let nome = "";
    linhas.forEach(l => {
        if(l.toLowerCase().includes("nome:")) nome = l.split(":")[1].trim();
    });
    
    if(nome) {
        document.getElementById("nomeCliente").value = nome;
        alert("Dados extra√≠dos! Complete e salve.");
        document.getElementById("areaImportacao").style.display = "none";
    } else {
        alert("N√£o consegui identificar o nome no texto.");
    }
}

function toggleImportacaoTexto() {
    const div = document.getElementById("areaImportacao");
    div.style.display = div.style.display === "none" ? "block" : "none";
}

// --- AGENDA & CALEND√ÅRIO ---
function carregarClientesSelect() {
    const selects = [document.getElementById("idClienteSelect"), document.getElementById("idClienteAlbumSelect")];
    const clientes = getDados("clientes").sort((a,b) => a.nome.localeCompare(b.nome));
    
    selects.forEach(sel => {
        if(!sel) return;
        sel.innerHTML = '<option value="">Selecione pelo ID ou Nome...</option>';
        clientes.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = `#${c.id} - ${c.nome}`;
            sel.appendChild(opt);
        });
    });
}

function selecionarClientePorID(id) {
    const select = document.getElementById("idClienteSelect");
    if(id) {
        select.value = id;
    } else {
        select.value = "";
    }
}

function atualizarRestante() {
    const pct = parseFloat(document.getElementById("valorPacote").value) || 0;
    const res = parseFloat(document.getElementById("reservaValor").value) || 0;
    document.getElementById("valorNoDia").value = (pct - res).toFixed(2);
}

function agendar() {
    const idCliente = document.getElementById("idClienteSelect").value;
    const data = document.getElementById("dataAgenda").value;
    const hora = document.getElementById("horaInicio").value;
    
    if(!idCliente || !data || !hora) return alert("Preencha cliente, data e hora.");

    const clientes = getDados("clientes");
    const cliente = clientes.find(c => c.id == idCliente);

    let agendamentos = getDados("agendamentos");
    const novoId = agendamentos.length > 0 ? Math.max(...agendamentos.map(a => a.id)) + 1 : 1;

    const agendamento = {
        id: novoId,
        idCliente: idCliente,
        nome: cliente.nome,
        data: data,
        hora: hora,
        fim: document.getElementById("horaFim").value,
        tipo: document.getElementById("tipoSessao").value,
        tema: document.getElementById("temaSessao").value,
        pacote: document.getElementById("pacoteSessao").value,
        valorPacote: parseFloat(document.getElementById("valorPacote").value) || 0,
        reserva: parseFloat(document.getElementById("reservaValor").value) || 0,
        valorDia: parseFloat(document.getElementById("valorNoDia").value) || 0,
        status: 'Agendado'
    };

    agendamentos.push(agendamento);
    setDados("agendamentos", agendamentos);
    alert("Agendamento criado!");
    
    document.getElementById("valorPacote").value = "";
    document.getElementById("reservaValor").value = "";
    document.getElementById("buscaIdClienteAgenda").value = ""; 
    mostrarTela('tela-inicio');
}

function listarProximos() {
    const lista = document.getElementById("listaProximosAgendamentos");
    lista.innerHTML = "";
    const hoje = new Date().toISOString().split('T')[0];
    
    let agendamentos = getDados("agendamentos");
    agendamentos = agendamentos.filter(a => a.data >= hoje && a.status !== 'Finalizado').sort((a,b) => a.data.localeCompare(b.data));

    if(agendamentos.length === 0) {
        lista.innerHTML = "<li class='list-group-item text-center text-muted'>Nenhuma sess√£o futura.</li>";
        return;
    }

    agendamentos.forEach(a => {
        const dataF = new Date(a.data + 'T00:00').toLocaleDateString('pt-BR');
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.innerHTML = `
            <div class="d-flex justify-content-between">
                <strong>${dataF} - ${a.hora}</strong>
                <span class="badge bg-secondary">${a.id}</span>
            </div>
            <div class="fw-bold text-success">${a.nome}</div>
            <small>${a.tipo} | ${a.pacote}</small>
            <div class="d-flex justify-content-between mt-2 align-items-center">
                <small>Restante: <b>R$ ${a.valorDia.toFixed(2)}</b></small>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="prepararMensagem(${a.id})"><i class="fas fa-whatsapp"></i></button>
                    <button class="btn btn-sm btn-success" onclick="abrirModalFinalizar(${a.id})">‚úî Finalizar</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="excluirAgendamento(${a.id})"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;
        lista.appendChild(li);
    });
}

function excluirAgendamento(id) {
    if(confirm("Excluir este agendamento?")) {
        let agendamentos = getDados("agendamentos");
        agendamentos = agendamentos.filter(a => a.id != id);
        setDados("agendamentos", agendamentos);
        listarProximos();
        renderizarCalendario();
    }
}

// --- CALEND√ÅRIO ---
let mesAtual = new Date().getMonth();
let anoAtual = new Date().getFullYear();

function mudarMes(delta) {
    mesAtual += delta;
    if(mesAtual > 11) { mesAtual = 0; anoAtual++; }
    if(mesAtual < 0) { mesAtual = 11; anoAtual--; }
    renderizarCalendario();
}

function renderizarCalendario() {
    const container = document.getElementById("calendarioAgendamentos");
    const label = document.getElementById("mesAtualLabel");
    container.innerHTML = "";
    const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    label.textContent = `${meses[mesAtual]} ${anoAtual}`;
    const primeiroDia = new Date(anoAtual, mesAtual, 1).getDay();
    const diasNoMes = new Date(anoAtual, mesAtual + 1, 0).getDate();
    const calDiv = document.createElement("div");
    calDiv.className = "calendar";

    for(let i=0; i<primeiroDia; i++) calDiv.appendChild(document.createElement("div"));

    const agendamentos = getDados("agendamentos");
    for(let dia=1; dia<=diasNoMes; dia++) {
        const diaDiv = document.createElement("div");
        diaDiv.className = "calendar-day";
        diaDiv.innerHTML = `<span>${dia}</span>`;
        const dataCheck = `${anoAtual}-${String(mesAtual+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
        const doDia = agendamentos.filter(a => a.data === dataCheck && a.status !== 'Finalizado');
        
        doDia.forEach(a => {
            const barra = document.createElement("div");
            barra.className = "barra-cor";
            if(a.tipo.includes("Anivers√°rio")) barra.classList.add("cal-azul");
            else if(a.tipo.includes("Gestante")) barra.classList.add("cal-roxo");
            else if(a.tipo.includes("Smash")) barra.classList.add("cal-laranja");
            else barra.classList.add("cal-verde");
            diaDiv.appendChild(barra);
        });

        if(doDia.length > 0) {
            diaDiv.onclick = () => {
                const painel = document.getElementById("eventosDoDia");
                painel.style.display = "block";
                painel.innerHTML = `<strong>Dia ${dia}:</strong><br>` + doDia.map(a => `${a.hora} - ${a.nome} (${a.tipo})`).join('<br>');
            };
        }
        calDiv.appendChild(diaDiv);
    }
    container.appendChild(calDiv);
}

// --- √ÅLBUNS ---
function salvarAlbum() {
    const idCliente = document.getElementById("idClienteAlbumSelect").value;
    if(!idCliente) return alert("Selecione um cliente");
    const clientes = getDados("clientes");
    const cliente = clientes.find(c => c.id == idCliente);
    let albuns = getDados("albuns");
    albuns = albuns.filter(a => a.idCliente != idCliente);
    
    albuns.push({
        idCliente: idCliente,
        nome: cliente.nome,
        tipo: document.getElementById("tipoAlbum").value,
        fase: document.getElementById("faseAlbum").value
    });
    
    setDados("albuns", albuns);
    listarAlbuns();
    alert("Status do √°lbum atualizado.");
}

function listarAlbuns() {
    const lista = document.getElementById("listaAlbuns");
    lista.innerHTML = "";
    const albuns = getDados("albuns");
    albuns.forEach(a => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
            <div>
                <strong>${a.nome}</strong><br>
                <span class="badge bg-primary">${a.tipo}</span> <span class="badge bg-warning text-dark">${a.fase}</span>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="excluirAlbum('${a.idCliente}')">X</button>
        `;
        lista.appendChild(li);
    });
}

function excluirAlbum(id) {
    let albuns = getDados("albuns");
    albuns = albuns.filter(a => a.idCliente != id);
    setDados("albuns", albuns);
    listarAlbuns();
}

// --- FINANCEIRO ---
function abrirModalFinalizar(id) {
    document.getElementById("finalizarId").value = id;
    new bootstrap.Modal(document.getElementById('finalizarModal')).show();
}

function salvarDespesasEFinalizar() {
    const id = parseInt(document.getElementById("finalizarId").value);
    const uber = parseFloat(document.getElementById("finalizarUber").value) || 0;
    const album = parseFloat(document.getElementById("finalizarAlbum").value) || 0;
    const outras = parseFloat(document.getElementById("finalizarOutras").value) || 0;

    let agendamentos = getDados("agendamentos");
    const index = agendamentos.findIndex(a => a.id == id);
    
    if(index > -1) {
        agendamentos[index].status = "Finalizado";
        setDados("agendamentos", agendamentos);
        let despesas = getDados("despesas");
        despesas.push({
            idAgendamento: id,
            data: new Date().toISOString().split('T')[0],
            uber, album, outras,
            total: uber + album + outras
        });
        setDados("despesas", despesas);
        alert("Sess√£o finalizada e despesas salvas!");
        bootstrap.Modal.getInstance(document.getElementById('finalizarModal')).hide();
        listarProximos();
        renderizarCalendario();
    }
}

function exibirDashboardFinanceiro() {
    const agendamentos = getDados("agendamentos");
    const despesas = getDados("despesas");
    const receitaTotal = agendamentos.reduce((acc, curr) => acc + (curr.valorPacote || 0), 0);
    const despesaTotal = despesas.reduce((acc, curr) => acc + (curr.total || 0), 0);
    const lucro = receitaTotal - despesaTotal;
    const div = document.getElementById("resultadoRelatorio");
    div.innerHTML = `
        <div class="row g-2">
            <div class="col-6">
                <div class="card p-3 text-center bg-success text-white">
                    <h6>Receita</h6>
                    <h3>R$ ${receitaTotal.toFixed(2)}</h3>
                </div>
            </div>
            <div class="col-6">
                <div class="card p-3 text-center bg-danger text-white">
                    <h6>Despesas</h6>
                    <h3>R$ ${despesaTotal.toFixed(2)}</h3>
                </div>
            </div>
            <div class="col-12">
                <div class="card p-3 text-center border-primary text-primary">
                    <h6>Lucro L√≠quido Estimado</h6>
                    <h1>R$ ${lucro.toFixed(2)}</h1>
                </div>
            </div>
        </div>
    `;
}

function gerarRelatorioDespesas() {
    const despesas = getDados("despesas");
    let html = "<ul class='list-group mt-3'>";
    despesas.forEach(d => {
        html += `<li class='list-group-item'>Data: ${d.data} | Total: R$ ${d.total.toFixed(2)} <small>(Uber: ${d.uber}, √Ålbum: ${d.album}, Outros: ${d.outras})</small></li>`;
    });
    html += "</ul>";
    document.getElementById("resultadoRelatorio").innerHTML = html;
}

// --- BACKUP ---
function exportarBackup() {
    const data = {
        clientes: getDados("clientes"),
        agendamentos: getDados("agendamentos"),
        albuns: getDados("albuns"),
        despesas: getDados("despesas"),
        // Backup dos modulos personalizados
        custom_modules: getDados("custom_modules")
    };
    
    // Backup dados dos modulos dinamicos
    const modulos = getDados("custom_modules");
    modulos.forEach(m => {
        data['custom_data_' + m.id] = getDados('custom_data_' + m.id);
    });

    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup_crm_rcf_v4_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}

function importarBackup(event) {
    const file = event.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if(data.clientes) setDados("clientes", data.clientes);
            if(data.agendamentos) setDados("agendamentos", data.agendamentos);
            if(data.albuns) setDados("albuns", data.albuns);
            if(data.despesas) setDados("despesas", data.despesas);
            if(data.custom_modules) setDados("custom_modules", data.custom_modules);
            
            // Restaura dados dinamicos
            if(data.custom_modules) {
                data.custom_modules.forEach(m => {
                    const key = 'custom_data_' + m.id;
                    if(data[key]) setDados(key, data[key]);
                });
            }

            alert("Restaura√ß√£o conclu√≠da com sucesso! Recarregando...");
            location.reload();
        } catch(err) {
            alert("Erro no arquivo de backup.");
        }
    };
    reader.readAsText(file);
}

// --- MENSAGENS ---
function prepararMensagem(idAgendamento) {
    document.getElementById("idAgendamentoTexto").value = idAgendamento;
    gerarTextoWhatsAppPorID();
    mostrarTela('tela-extra1');
}

function gerarTextoWhatsAppPorID() {
    const id = document.getElementById("idAgendamentoTexto").value;
    const agendamentos = getDados("agendamentos");
    const agendamento = agendamentos.find(a => a.id == id);
    if(!agendamento) return alert("Agendamento n√£o encontrado");
    const diaSemana = new Date(agendamento.data + 'T00:00').toLocaleDateString('pt-BR', { weekday: 'long' });
    const dataFormatada = new Date(agendamento.data + 'T00:00').toLocaleDateString('pt-BR');

    const texto = `Ol√°, ${agendamento.nome}! Tudo bem? üòä

Seu agendamento est√° confirmado com sucesso!
Aqui est√£o os detalhes da sua sess√£o:

üÜî *ID:* ${agendamento.id}
üì∏ *Sess√£o:* ${agendamento.tipo}
üì¶ *Pacote:* ${agendamento.pacote}
üìç *Data:* ${diaSemana}, ${dataFormatada}
üïí *Hor√°rio:* ${agendamento.hora} √†s ${agendamento.fim}

üí∞ *Valor do Pacote:* R$${(agendamento.valorPacote || 0).toFixed(2)}
üí≥ *Sinal Pago:* R$${(agendamento.reserva || 0).toFixed(2)}
üíµ *Restante no Dia:* R$${(agendamento.valorDia || 0).toFixed(2)}

üìå *Local: Rodrigo Costa Fotografia*

*Qualquer d√∫vida, √© s√≥ me chamar!*
‚ú® _Vai ser um prazer registrar esse momento especial!_

_Atenciosamente,_  
Rodrigo Costa`;

    document.getElementById("mensagemWhatsTexto").value = texto;
}

function copiarTexto(elementId) {
    const texto = document.getElementById(elementId);
    texto.select();
    document.execCommand("copy");
    alert("Texto copiado!");
}
</script>
</body>
</html>
